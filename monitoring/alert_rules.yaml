# Prometheus alert rules for Athena (Phase 3)
# Defines thresholds for SLA compliance and system health

groups:
  - name: athena_alerts
    interval: 30s
    rules:
      # ====================================================================
      # Performance & Latency Alerts
      # ====================================================================

      - alert: HighOperationLatencyP95
        expr: histogram_quantile(0.95, rate(athena_operation_latency_seconds_bucket[5m])) > 0.05
        for: 5m
        labels:
          severity: warning
          service: athena
        annotations:
          summary: "Operation latency P95 above threshold"
          description: "95th percentile latency is {{ $value | humanizeDuration }} (threshold: 50ms)"
          runbook: "https://wiki.example.com/athena/latency"

      - alert: HighOperationLatencyP99
        expr: histogram_quantile(0.99, rate(athena_operation_latency_seconds_bucket[5m])) > 0.1
        for: 5m
        labels:
          severity: critical
          service: athena
        annotations:
          summary: "Operation latency P99 critically high"
          description: "99th percentile latency is {{ $value | humanizeDuration }} (threshold: 100ms)"

      # ====================================================================
      # Error Rate Alerts
      # ====================================================================

      - alert: HighErrorRate
        expr: |
          (sum(rate(athena_operations_total{status="error"}[5m])) /
           sum(rate(athena_operations_total[5m]))) > 0.001
        for: 2m
        labels:
          severity: warning
          service: athena
        annotations:
          summary: "Error rate above 0.1%"
          description: "Current error rate: {{ $value | humanizePercentage }}"

      - alert: CriticalErrorRate
        expr: |
          (sum(rate(athena_operations_total{status="error"}[5m])) /
           sum(rate(athena_operations_total[5m]))) > 0.01
        for: 1m
        labels:
          severity: critical
          service: athena
        annotations:
          summary: "Critical error rate detected"
          description: "Error rate: {{ $value | humanizePercentage }} (threshold: 1%)"

      # ====================================================================
      # Resource Alerts
      # ====================================================================

      - alert: HighMemoryUsage
        expr: athena_memory_bytes > 1e9
        for: 5m
        labels:
          severity: warning
          service: athena
        annotations:
          summary: "Memory usage above 1GB"
          description: "Current memory: {{ $value | humanize1024 }} (threshold: 1GB)"

      - alert: CriticalMemoryUsage
        expr: athena_memory_bytes > 2e9
        for: 2m
        labels:
          severity: critical
          service: athena
        annotations:
          summary: "Memory usage critically high"
          description: "Current memory: {{ $value | humanize1024 }} (threshold: 2GB)"

      - alert: HighCPUUsage
        expr: athena_cpu_percent > 80
        for: 5m
        labels:
          severity: warning
          service: athena
        annotations:
          summary: "CPU usage above 80%"
          description: "Current CPU: {{ $value | humanize }}% (threshold: 80%)"

      # ====================================================================
      # Database Alerts
      # ====================================================================

      - alert: HighDatabaseConnectionUsage
        expr: athena_db_connections_active > 10
        for: 5m
        labels:
          severity: warning
          service: athena
        annotations:
          summary: "Database connections above normal"
          description: "Active connections: {{ $value }} (threshold: 10)"

      # ====================================================================
      # Cache Alerts
      # ====================================================================

      - alert: LowCacheHitRate
        expr: |
          (sum(rate(athena_cache_hits_total[5m])) /
           (sum(rate(athena_cache_hits_total[5m])) + sum(rate(athena_cache_misses_total[5m])))) < 0.3
        for: 10m
        labels:
          severity: info
          service: athena
        annotations:
          summary: "Cache hit rate below 30%"
          description: "Current hit rate: {{ $value | humanizePercentage }}"

      - alert: HighCacheEvictionRate
        expr: rate(athena_cache_evictions_total[5m]) > 1
        for: 5m
        labels:
          severity: warning
          service: athena
        annotations:
          summary: "High cache eviction rate"
          description: "Evictions per second: {{ $value | humanize }}"

      # ====================================================================
      # Consolidation Alerts
      # ====================================================================

      - alert: ConsolidationNotRunning
        expr: |
          (time() - max(max_over_time(athena_consolidations_total[1h]))) > 3600
        for: 1h
        labels:
          severity: warning
          service: athena
        annotations:
          summary: "No consolidation run in the last hour"
          description: "Pattern extraction may not be up to date"

      # ====================================================================
      # Data Growth Alerts
      # ====================================================================

      - alert: RapidMemoryGrowth
        expr: |
          rate(athena_memories_stored_total[10m]) > 100
        for: 10m
        labels:
          severity: info
          service: athena
        annotations:
          summary: "Rapid memory storage growth"
          description: "Storing {{ $value | humanize }} memories/second"

      - alert: RapidProcedureGrowth
        expr: |
          rate(athena_procedures_learned_total[1h]) > 10
        for: 30m
        labels:
          severity: info
          service: athena
        annotations:
          summary: "Rapid procedure learning"
          description: "Learning {{ $value | humanize }} procedures/hour"

      # ====================================================================
      # Instance Availability
      # ====================================================================

      - alert: AthenaServiceDown
        expr: up{job="athena"} == 0
        for: 2m
        labels:
          severity: critical
          service: athena
        annotations:
          summary: "Athena service is down"
          description: "Athena has been unavailable for 2 minutes"
