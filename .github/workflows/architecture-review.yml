name: Architecture Review

on:
  pull_request:
    types: [opened, synchronize, reopened]

permissions:
  contents: read
  pull-requests: write
  statuses: write

jobs:
  architecture-review:
    runs-on: ubuntu-latest
    name: Automated Architecture Review

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Full history for better analysis

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -e .
          pip install pytest requests

      - name: Get changed files
        id: changed-files
        uses: tj-actions/changed-files@v40
        with:
          files: |
            **/*.py
            **/*.md
            **/ADR*.md
            **/adr*.md

      - name: Run Architecture Review
        id: review
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          PR_NUMBER: ${{ github.event.pull_request.number }}
          REPO: ${{ github.repository }}
          COMMIT_SHA: ${{ github.event.pull_request.head.sha }}
        run: |
          python scripts/run_pr_review.py \
            --pr-number "$PR_NUMBER" \
            --changed-files "${{ steps.changed-files.outputs.all_changed_files }}" \
            --pr-title "${{ github.event.pull_request.title }}" \
            --pr-body "${{ github.event.pull_request.body }}" \
            --repo "$REPO" \
            --commit-sha "$COMMIT_SHA" \
            --github-token "$GITHUB_TOKEN" \
            --project-id 1

      - name: Upload review results
        if: always()
        uses: actions/upload-artifact@v3
        with:
          name: architecture-review-results
          path: architecture-review-*.json
          retention-days: 30

      - name: Comment on PR (if review failed)
        if: steps.review.outcome == 'failure'
        uses: actions/github-script@v7
        with:
          script: |
            github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body: '⚠️ Architecture review found critical issues. Please check the review comments and address them before merging.'
            })

      - name: Set status check
        if: always()
        uses: actions/github-script@v7
        with:
          script: |
            const state = '${{ steps.review.outcome }}' === 'success' ? 'success' : 'failure';
            await github.rest.repos.createCommitStatus({
              owner: context.repo.owner,
              repo: context.repo.repo,
              sha: '${{ github.event.pull_request.head.sha }}',
              state: state,
              context: 'Architecture Review',
              description: state === 'success' ? 'All checks passed' : 'Issues found - see review'
            });
