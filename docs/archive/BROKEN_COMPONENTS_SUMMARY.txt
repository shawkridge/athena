================================================================================
ATHENA CODEBASE: BROKEN/INCOMPLETE COMPONENTS QUICK REFERENCE
================================================================================

CRITICAL ISSUES (BLOCKING):
================================================================================

1. ConsolidationRouter - SQLite Code with PostgreSQL Backend
   Location: src/athena/working_memory/consolidation_router.py
   Lines: 72, 93-98, 172-175, 210-216, 305-311, 415-447, 504-524, 533+
   Issue: Uses .db.conn (SQLite-only) but PostgreSQL has no .conn attribute
   Count: 24+ instances
   Methods Affected:
     - route_item() [line 69]
     - consolidate_item() [line 145]
     - _extract_features() [line 188]
     - train() [line 293]
     - _consolidate_to_layer() [line 403]
   Status: COMPLETELY NON-FUNCTIONAL - Will crash on any access
   Fix Effort: HIGH - Requires async refactor


2. MemoryAPI - Confusing async/sync Bridge
   Location: src/athena/mcp/memory_api.py
   Lines: 58-84 (defines _run_async), 168 (calls run_async), 283
   Issue 1: Defines local _run_async() but calls run_async() [NameError]
   Issue 2: _ensure_default_project() doesn't import from async_utils.py
   Issue 3: Hardcoded fallback to project_id=1 without validation
   Methods Affected:
     - _ensure_default_project() [line 140]
     - remember() [line 229]
     - recall() [line 299]
     - recall_events() [line 420]
     - And all 30+ API methods that use _ensure_default_project()
   Status: Works by accident (run_async defined locally), but wrong pattern
   Fix Effort: MEDIUM - Simple import + fallback review


3. SyncCursor - Duplicated Async/Sync Logic  
   Location: src/athena/core/database_postgres.py
   Lines: 54-200, specifically 97-113
   Issue: Duplicates run_async() logic with thread pool anti-pattern
   Problem: asyncio.run() cannot be called in ThreadPoolExecutor
   Methods Affected:
     - _execute_async() [line 121]
     - All sync store methods that call execute()
   Status: Works in simple cases, fragile under load
   Fix Effort: MEDIUM - Replace with run_async_in_thread()


================================================================================
SECONDARY ISSUES (FUNCTIONAL BUT INCOMPLETE):
================================================================================

4. MemoryStore - Inconsistent Async/Sync API
   Location: src/athena/memory/store.py
   Lines: 86-124 (async remember), 126-150 (sync forget/list_memories)
   Issue: Mixed async/sync without clear pattern
   Methods:
     ✓ async remember() [line 86]
     ✗ sync forget() [line 126] - Direct call, no async wrapper
     ✗ sync list_memories() [line 137] - Direct call, no async wrapper
     ✗ async get_project_by_path() [line 173] - No sync wrapper
   Status: Works but inconsistent API, maintenance burden
   Fix Effort: LOW - Add sync wrappers following ProjectManager pattern


5. ProjectManager - Sync Wrappers Incomplete
   Location: src/athena/projects/manager.py
   Lines: 87-103
   Issue: Missing sync wrappers for some async methods
   Methods:
     ✓ async detect_current_project() + detect_current_project_sync()
     ✓ async get_or_create_project() + get_or_create_project_sync()
     ✗ async require_project() [line 68] - No sync wrapper
   Status: Mostly complete, minor inconsistency
   Fix Effort: LOW - Add missing require_project_sync()


6. ConsolidationRouter - Silent Error Handling
   Location: src/athena/working_memory/consolidation_router.py
   Lines: 314-315, 349-351, 356-357
   Issue: Uses print() instead of logging
   Methods:
     - train() [line 293] - Multiple print() statements
   Problem: Silent failures, no log context, harder to debug
   Status: Code quality issue, not blocking
   Fix Effort: LOW - Replace print() with logger.info/warning


7. Database Connection Pooling - No Monitoring
   Location: src/athena/core/database_postgres.py
   Lines: 26 (AsyncConnectionPool imported, not exposed)
   Issue: No methods to inspect/monitor pool stats
   Missing:
     - get_pool_stats() method
     - health_check() method
     - Automatic recovery on connection loss
   Status: Infrastructure gap, not blocking
   Fix Effort: MEDIUM - Add monitoring methods


================================================================================
ERROR HANDLING PATTERNS:
================================================================================

GOOD PATTERNS (Follow these):
  • manager.py lines 92-122: Graceful fallback (try provider1, then provider2)
  • handlers.py: Try/except with logging and sensible fallback

BAD PATTERNS (Avoid these):
  • consolidation_router.py: print() instead of logger
  • consolidation_router.py: return False with no context
  • database_postgres.py SyncCursor: Uncaught async exceptions


================================================================================
FILE SUMMARY - FILES WITH .conn (SQLite-only) REFERENCES:
================================================================================

CRITICAL (Affect core functionality):
  • src/athena/working_memory/consolidation_router.py [24 instances]

MEDIUM (Affect features):
  • src/athena/meta/store.py
  • src/athena/orchestration/task_queue.py
  • src/athena/planning/validation.py
  • src/athena/executive/progress.py
  • And 15+ others

Total files using .conn: ~23 files
Total .conn references: ~242 instances


================================================================================
ASYNC FUNCTIONS INVENTORY:
================================================================================

Core Database (100% async):
  • store_memory(), get_memory(), semantic_search()
  • create_project(), get_project_by_path()
  • create_task(), update_task()

Memory Stores (50% async, 50% sync):
  • MemoryStore.remember() [async]
  • MemoryStore.forget() [sync, direct call]
  • ProjectManager methods [async + sync wrappers]

MCP Handlers (95% sync):
  • All tool handlers are sync
  • They call async store methods via run_async()

Working Memory (0% async - ALL USE .conn):
  • ConsolidationRouter [all sync, uses .conn]
  • CentralExecutive, PhonologicalLoop, etc. [sync]


================================================================================
RECOMMENDED FIXES (Priority Order):
================================================================================

IMMEDIATE (This session):
  1. Fix ConsolidationRouter to use async database methods
     - Replace .db.conn with await self.db.get_connection()
     - Convert ? placeholders to %s (PostgreSQL)
     - Add proper error logging
     - Status: BLOCKING - 24+ failures if touched

  2. Fix MemoryAPI run_async confusion
     - Import from async_utils: from ..core.async_utils import run_async
     - Remove local _run_async() or use it consistently
     - Fix hardcoded project_id=1 fallback
     - Status: BUG - Affects all API methods

  3. Fix SyncCursor duplicate logic
     - Use run_async_in_thread() from async_utils
     - Remove duplicate _run_async() implementation
     - Status: FRAGILE - Works but risky

THIS WEEK:
  4. Fix MemoryStore sync/async consistency
  5. Add missing sync wrappers (require_project_sync)
  6. Replace print() with logger in ConsolidationRouter

NEXT WEEK:
  7. Add connection pool monitoring methods
  8. Document async/sync boundary in CLAUDE.md
  9. Add comprehensive async/sync tests


================================================================================
KEY FILES TO UNDERSTAND:
================================================================================

1. src/athena/core/async_utils.py [232 lines]
   - run_async(coro, timeout) - Main async/sync bridge
   - run_async_in_thread(coro, timeout) - For when loop running
   - sync_wrapper decorator - Creates sync wrappers
   - AsyncContextBridge - Context manager for bridging

2. src/athena/core/database_postgres.py [500+ lines]
   - PostgresDatabase class - Async-first database
   - SyncCursor class - Sync wrapper (HAS ISSUES)
   - All core store methods are async

3. src/athena/mcp/memory_api.py [1400+ lines]
   - MemoryAPI.create() - Factory method
   - _ensure_default_project() - Project initialization (HAS ISSUES)
   - 30+ API methods (remember, recall, etc)

4. src/athena/working_memory/consolidation_router.py [550+ lines]
   - ConsolidationRouter class - ML routing (COMPLETELY BROKEN)
   - Uses .conn pattern throughout
   - 24+ method calls using .conn


================================================================================
TESTING STATUS:
================================================================================

✓ Core database tests likely pass (PostgreSQL async works)
✓ ProjectManager sync wrappers likely tested
✓ Manager/MemoryAPI tests may pass (run_async works by accident)

✗ ConsolidationRouter tests will fail (AttributeError on .conn)
✗ Async/sync bridging tests incomplete
✗ Error scenarios in run_async not tested

Test files: tests/unit/*, tests/integration/*
Run: pytest tests/ -v --tb=short


================================================================================
Quick Reference: Which Components Are Broken
================================================================================

WILL CRASH:
  ✗ ConsolidationRouter.route_item()
  ✗ ConsolidationRouter.consolidate_item()
  ✗ ConsolidationRouter.train()
  ✗ ConsolidationRouter._consolidate_to_layer()
  ✗ And 8 other methods accessing .conn

WILL PRODUCE WRONG RESULTS:
  ~ MemoryAPI._ensure_default_project() [uses wrong run_async]
  ~ SyncCursor._execute_async() [thread pool issue]

WORKS BUT FRAGILE:
  ~ MemoryStore (mixed async/sync)
  ~ ProjectManager (mostly complete)

WORKS FINE:
  ✓ Database layer (PostgreSQL async)
  ✓ async_utils.py (run_async, run_async_in_thread)
  ✓ Manager/Router pattern (good design)

